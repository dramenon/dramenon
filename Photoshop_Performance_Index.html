#target photoshop

// Extract and classify layers in the active document
function extractLayersByType() {
    var doc = app.activeDocument;
    var layers = doc.layers;
    var layerInfo = {
        textLayers: [], shapeLayers: [], imageLayers: [],
        smartObjectLayers: [], patternLayers: [], lutLayers: [], otherLayers: [],
        textLayerCount: 0, shapeLayerCount: 0, imageLayerCount: 0,
        smartObjectLayerCount: 0, patternLayerCount: 0, lutLayerCount: 0, otherLayerCount: 0,
        totalLayers: 0, totalFolders: 0
    };

    // Get layer info
    function getLayerInfo(layer) {
        var info = layer.name;
        if (layer.grouped) info += " (Clipped)";
        if (hasLayerStyles(layer)) info += " (FX)";
        return info;
    }

    // Check if a layer has styles
    function hasLayerStyles(layer) {
        try {
            return layer.layerEffects.isValid;
        } catch (e) {
            return false;
        }
    }

    // Traverse and classify layers
    function traverseLayers(layers) {
        for (var i = 0; i < layers.length; i++) {
            var layer = layers[i];
            layerInfo.totalLayers++;
            if (layer.typename === "ArtLayer") {
                if (layer.kind === LayerKind.TEXT) {
                    layerInfo.textLayers.push(getLayerInfo(layer));
                    layerInfo.textLayerCount++;
                } else if (layer.kind === LayerKind.NORMAL) {
                    layerInfo.imageLayers.push(getLayerInfo(layer));
                    layerInfo.imageLayerCount++;
                } else if (layer.kind === LayerKind.SOLIDFILL) {
                    layerInfo.shapeLayers.push(getLayerInfo(layer));
                    layerInfo.shapeLayerCount++;
                } else if (layer.kind === LayerKind.SMARTOBJECT) {
                    layerInfo.smartObjectLayers.push(getLayerInfo(layer) + " (Smart Object)");
                    layerInfo.smartObjectLayerCount++;
                } else if (layer.kind === LayerKind.PATTERNFILL) {
                    layerInfo.patternLayers.push(getLayerInfo(layer) + " (Patterns)");
                    layerInfo.patternLayerCount++;
                } else if (layer.kind === LayerKind.COLORLOOKUP) {
                    layerInfo.lutLayers.push(getLayerInfo(layer) + " (LUT)");
                    layerInfo.lutLayerCount++;
                } else {
                    layerInfo.otherLayers.push(getLayerInfo(layer));
                    layerInfo.otherLayerCount++;
                }
            } else if (layer.typename === "LayerSet") {
                layerInfo.totalFolders++;
                traverseLayers(layer.layers);
            }
        }
    }

    traverseLayers(layers);
    return layerInfo;
}

// Retrieve document information
function getDocumentInfo() {
    var doc = app.activeDocument;
    var colorMode = ["RGB", "CMYK", "Grayscale", "Bitmap", "Indexed Color", "Lab Color", "Multichannel"][doc.mode];
    var bitDepth = ["1", "8", "16", "32"][doc.bitsPerChannel];
    var ppi = doc.resolution;
    var width = doc.width.as("px");
    var height = doc.height.as("px");

    return { colorMode: colorMode, bitDepth: bitDepth, ppi: ppi, width: width, height: height };
}

// Check document for performance issues
function checkPerformanceIssues() {
    var doc = app.activeDocument;
    var layerCount = doc.artLayers.length + doc.layerSets.length;
    var docWidth = doc.width.as('px');
    var docHeight = doc.height.as('px');
    var docResolution = doc.resolution;
    var docBitDepth = doc.bitsPerChannel;

    var performanceWarnings = [];

    // Check for large document size
    if (docWidth * docHeight > 20000000) performanceWarnings.push("Large document size (" + docHeight + " x " + docWidth + " pixels).");
    // Check for high resolution
    if (docResolution > 300) performanceWarnings.push("High resolution (" + docResolution + " DPI).");
    // Check for too many layers
    if (layerCount > 100) performanceWarnings.push("High number of layers (" + layerCount + ").");

    // Check for smart objects
    var smartObjectCount = 0;
    for (var i = 0; i < doc.artLayers.length; i++) {
        if (doc.artLayers[i].kind == LayerKind.SMARTOBJECT) smartObjectCount++;
    }
    if (smartObjectCount > 10) performanceWarnings.push("Many smart objects (" + smartObjectCount + ").");

    // Check for layer effects
    var layerEffectsCount = 0;
    for (var j = 0; j < doc.artLayers.length; j++) {
        if (doc.artLayers[j].visible && hasLayerEffects(doc.artLayers[j])) layerEffectsCount++;
    }
    if (layerEffectsCount > 5) performanceWarnings.push("Many layers with effects (" + layerEffectsCount + ").");

    // Check for bit depth
    if (docBitDepth != BitsPerChannelType.EIGHT) performanceWarnings.push("Bit depth is " + ["1-bit", "8-bit", "16-bit", "32-bit"][docBitDepth] + ".");

    return performanceWarnings;
}

// Check if a layer has effects
function hasLayerEffects(layer) {
    try {
        return layer.layerDescriptor.hasKey(stringIDToTypeID('layerEffects'));
    } catch (e) {
        return false;
    }
}

// Display information dialog
function showLayerInfoDialog(layerInfo, docInfo, performanceWarnings) {
    var dialog = new Window("dialog", "PreFlight Check");

    var docInfoGroup = dialog.add("panel", undefined, "Document Information");
    docInfoGroup.add("statictext", undefined, "Color Mode: " + docInfo.colorMode);
    docInfoGroup.add("statictext", undefined, "Bit Depth: " + docInfo.bitDepth);
    docInfoGroup.add("statictext", undefined, "Resolution: " + docInfo.ppi + " ppi");
    docInfoGroup.add("statictext", undefined, "Dimensions: " + docInfo.width + " x " + docInfo.height + " pixels");

    var countGroup = dialog.add("panel", undefined, "Counts");
    countGroup.add("statictext", undefined, "Total Layers: " + layerInfo.totalLayers);
    countGroup.add("statictext", undefined, "Total Folders: " + layerInfo.totalFolders);

    // Add performance warnings
    if (performanceWarnings.length > 0) {
        var performanceGroup = dialog.add("panel", undefined, "Performance Warnings");
        var performanceList = performanceGroup.add("edittext", undefined, performanceWarnings.join("\n"), { multiline: true, readonly: true });
        performanceList.size = [300, 50];
    }

    // Add layer information groups
    function addLayerGroup(title, layers, count) {
        var group = dialog.add("panel", undefined, title + " (Count: " + count + ")");
        var list = group.add("edittext", undefined, layers.join("\n"), { multiline: true, readonly: true });
        list.size = [300, 50];
    }

    addLayerGroup("Text Layers", layerInfo.textLayers, layerInfo.textLayerCount);
    addLayerGroup("Image Layers", layerInfo.imageLayers, layerInfo.imageLayerCount);
    addLayerGroup("Shape Layers", layerInfo.shapeLayers, layerInfo.shapeLayerCount);
    addLayerGroup("Smart Object Layers", layerInfo.smartObjectLayers, layerInfo.smartObjectLayerCount);
    addLayerGroup("Pattern Layers", layerInfo.patternLayers, layerInfo.patternLayerCount);
    addLayerGroup("LUT Layers", layerInfo.lutLayers, layerInfo.lutLayerCount);
    addLayerGroup("Other Layers", layerInfo.otherLayers, layerInfo.otherLayerCount);

    var closeButton = dialog.add("button", undefined, "Close", { name: "close" });
    closeButton.onClick = function() { dialog.close(); };

    dialog.show();
}

// Gather information and display dialog
var layerInfo = extractLayersByType();
var docInfo = getDocumentInfo();
var performanceWarnings = checkPerformanceIssues();
showLayerInfoDialog(layerInfo, docInfo, performanceWarnings);
